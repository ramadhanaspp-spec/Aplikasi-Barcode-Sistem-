// Generator Barcode Implementation - Integrated with Scanner & Inventory
let currentBarcodeData = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    setDefaultDate();
    updatePriceDisplay();
});

// Setup Event Listeners
function setupEventListeners() {
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    
    if (hamburger) {
        hamburger.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            hamburger.classList.toggle('active');
        });
    }
    
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
                sidebar.classList.remove('active');
                hamburger.classList.remove('active');
            }
        }
    });
    
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                hamburger.classList.remove('active');
            }
        });
    });
    
    // Price input listener for live update
    const priceInput = document.getElementById('price');
    if (priceInput) {
        priceInput.addEventListener('input', updatePriceDisplay);
    }
}

// Set Default Production Date (Today)
function setDefaultDate() {
    const today = new Date();
    const dateString = today.toISOString().split('T')[0];
    document.getElementById('productionDate').value = dateString;
}

// Update Price Display
function updatePriceDisplay() {
    const price = parseInt(document.getElementById('price').value) || 0;
    const priceDisplay = document.getElementById('priceDisplay');
    priceDisplay.textContent = 'Rp ' + formatCurrency(price);
}

// Handle Generate Barcode
function handleGenerateBarcode(event) {
    event.preventDefault();
    
    // Get form values
    const variant = document.getElementById('productVariant').value;
    const weight = document.getElementById('weight').value;
    const price = parseInt(document.getElementById('price').value);
    const productionDate = document.getElementById('productionDate').value;
    const expiryDays = parseInt(document.getElementById('expiryDays').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    
    // Validate
    if (!variant || !price || !productionDate) {
        showNotification('Mohon lengkapi semua field yang required!', 'error');
        return;
    }
    
    // Calculate expiry date
    const prodDate = new Date(productionDate);
    const expDate = new Date(prodDate);
    expDate.setDate(expDate.getDate() + expiryDays);
    
    // Generate unique barcode
    const barcode = generateBarcodeNumber(variant, weight);
    
    // Prepare product data
    const productName = `Bawang Goreng ${variant} ${weight}g`;
    const productData = {
        name: productName,
        barcode: barcode,
        variant: variant,
        weight: weight,
        price: price,
        description: `Bawang Goreng ${variant} - ${weight} gram`,
        stock: quantity,
        productionDate: productionDate,
        expiryDate: expDate.toISOString().split('T')[0],
        createdAt: new Date().toISOString()
    };
    
    // Save to inventory
    saveToInventory(productData);
    
    // Store current barcode data
    currentBarcodeData = productData;
    
    // Display result
    displayBarcodeResult(productData);
    
    // Generate barcode visual
    generateBarcodeVisual(barcode);
    
    showNotification('Barcode berhasil digenerate dan ditambahkan ke inventory!', 'success');
}

// Generate Barcode Number
function generateBarcodeNumber(variant, weight) {
    // Format: PREFIX + VARIANT_CODE + WEIGHT_CODE + TIMESTAMP
    const prefix = 'BG'; // Bawang Goreng
    
    // Variant codes
    const variantCodes = {
        'Original': '001',
        'Pedas': '002',
        'Balado': '003',
        'BBQ': '004',
        'Keju': '005'
    };
    
    // Weight codes
    const weightCodes = {
        '50': '1',
        '100': '2',
        '250': '3',
        '500': '4',
        '1000': '5'
    };
    
    const variantCode = variantCodes[variant] || '000';
    const weightCode = weightCodes[weight] || '0';
    
    // Generate timestamp-based unique number (last 6 digits)
    const timestamp = Date.now().toString();
    const uniqueCode = timestamp.slice(-6);
    
    // Final barcode: BG + VARIANT(3) + WEIGHT(1) + UNIQUE(6) = 12 characters
    const barcode = `${prefix}${variantCode}${weightCode}${uniqueCode}`;
    
    return barcode;
}

// Save to Inventory
function saveToInventory(productData) {
    let items = JSON.parse(localStorage.getItem('bawangGorenStoreItems') || '[]');
    
    // Check if product with same variant and weight exists
    const existingIndex = items.findIndex(item => 
        item.variant === productData.variant && 
        item.weight === productData.weight
    );
    
    if (existingIndex !== -1) {
        // Update existing product - add stock and keep the newer expiry date
        items[existingIndex].stock += productData.stock;
        items[existingIndex].price = productData.price; // Update price
        
        // Keep the furthest expiry date
        const existingExpiry = new Date(items[existingIndex].expiryDate);
        const newExpiry = new Date(productData.expiryDate);
        if (newExpiry > existingExpiry) {
            items[existingIndex].expiryDate = productData.expiryDate;
        }
        
        // Update barcode to the latest one
        items[existingIndex].barcode = productData.barcode;
        items[existingIndex].productionDate = productData.productionDate;
        
        showNotification(`Stok ${productData.name} berhasil ditambahkan! Total stok: ${items[existingIndex].stock}`, 'success');
    } else {
        // Add new product
        items.push(productData);
        showNotification(`Produk baru ${productData.name} berhasil ditambahkan!`, 'success');
    }
    
    localStorage.setItem('bawangGorenStoreItems', JSON.stringify(items));
}

// Display Barcode Result
function displayBarcodeResult(data) {
    // Show result card
    const resultCard = document.getElementById('resultCard');
    resultCard.style.display = 'block';
    
    // Scroll to result
    setTimeout(() => {
        resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
    // Fill result data
    document.getElementById('resultProduct').textContent = data.name;
    document.getElementById('resultWeight').textContent = data.weight + ' gram';
    document.getElementById('resultPrice').textContent = 'Rp ' + formatCurrency(data.price);
    document.getElementById('resultProductionDate').textContent = formatDate(new Date(data.productionDate));
    document.getElementById('resultExpiryDate').textContent = formatDate(new Date(data.expiryDate));
    document.getElementById('resultQuantity').textContent = data.stock + ' unit';
    document.getElementById('barcodeNumber').textContent = data.barcode;
}

// Generate Barcode Visual
function generateBarcodeVisual(barcodeText) {
    try {
        // Generate for display
        JsBarcode("#barcodeCanvas", barcodeText, {
            format: "CODE128",
            width: 2,
            height: 80,
            displayValue: true,
            fontSize: 16,
            margin: 10
        });
        
        // Generate for print
        JsBarcode("#printBarcodeCanvas", barcodeText, {
            format: "CODE128",
            width: 2,
            height: 100,
            displayValue: false,
            margin: 10
        });
    } catch (error) {
        console.error('Error generating barcode:', error);
        showNotification('Error saat generate barcode visual', 'error');
    }
}

// Print Barcode
function printBarcode() {
    if (!currentBarcodeData) {
        showNotification('Tidak ada barcode untuk dicetak', 'error');
        return;
    }
    
    // Fill print area
    document.getElementById('printProductName').textContent = currentBarcodeData.name;
    document.getElementById('printBarcodeNumber').textContent = currentBarcodeData.barcode;
    document.getElementById('printWeight').textContent = currentBarcodeData.weight + ' gram';
    document.getElementById('printPrice').textContent = 'Rp ' + formatCurrency(currentBarcodeData.price);
    document.getElementById('printProductionDate').textContent = formatDate(new Date(currentBarcodeData.productionDate));
    document.getElementById('printExpiryDate').textContent = formatDate(new Date(currentBarcodeData.expiryDate));
    
    // Trigger print
    window.print();
}

// Download Barcode
function downloadBarcode() {
    if (!currentBarcodeData) {
        showNotification('Tidak ada barcode untuk diunduh', 'error');
        return;
    }
    
    try {
        // Get the barcode SVG
        const svg = document.getElementById('barcodeCanvas');
        const svgData = new XMLSerializer().serializeToString(svg);
        
        // Create canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size (larger for better quality)
        canvas.width = 400;
        canvas.height = 200;
        
        // Create image from SVG
        const img = new Image();
        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        
        img.onload = function() {
            // Fill white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw image
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // Add product info
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(currentBarcodeData.name, canvas.width / 2, canvas.height - 10);
            
            // Convert to PNG and download
            canvas.toBlob(function(blob) {
                const link = document.createElement('a');
                const downloadUrl = URL.createObjectURL(blob);
                const filename = `Barcode_${currentBarcodeData.barcode}_${formatDateForFilename(new Date())}.png`;
                
                link.href = downloadUrl;
                link.download = filename;
                link.click();
                
                URL.revokeObjectURL(downloadUrl);
                showNotification('Barcode berhasil diunduh!', 'success');
            });
            
            URL.revokeObjectURL(url);
        };
        
        img.src = url;
    } catch (error) {
        console.error('Error downloading barcode:', error);
        showNotification('Error saat mengunduh barcode', 'error');
    }
}

// Reset Form
function resetForm() {
    if (confirm('Apakah Anda yakin ingin mereset form?')) {
        document.getElementById('generatorForm').reset();
        setDefaultDate();
        updatePriceDisplay();
        
        // Hide result card
        document.getElementById('resultCard').style.display = 'none';
        currentBarcodeData = null;
        
        showNotification('Form berhasil direset', 'success');
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Format Date
function formatDate(date) {
    const options = { 
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    };
    return date.toLocaleDateString('id-ID', options);
}

// Format Date for Filename
function formatDateForFilename(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}${month}${day}_${hours}${minutes}`;
}

// Format Currency
function formatCurrency(amount) {
    return amount.toLocaleString('id-ID');
}

// Show Notification
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 10001;
        animation: slideInRight 0.3s ease;
        font-weight: 600;
        max-width: 400px;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// Handle logout
function handleLogout(event) {
    event.preventDefault();
    openLogoutModal();
}

// Open Logout Modal
function openLogoutModal() {
    let modal = document.getElementById('logoutModal');
    if (!modal) {
        modal = createLogoutModal();
        document.body.appendChild(modal);
    }
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
}

// Create Logout Modal
function createLogoutModal() {
    const modal = document.createElement('div');
    modal.id = 'logoutModal';
    modal.className = 'logout-modal';
    modal.innerHTML = `
        <div class="logout-overlay" onclick="closeLogoutModal()"></div>
        <div class="logout-content">
            <div class="logout-icon">
                <div class="icon-circle">
                    <span>üö™</span>
                </div>
            </div>
            <h2 class="logout-title">Konfirmasi Logout</h2>
            <p class="logout-message">Apakah Anda yakin ingin keluar dari sistem?</p>
            <div class="logout-actions">
                <button class="btn-logout-no" onclick="closeLogoutModal()">
                    <span>‚úñÔ∏è</span> Tidak
                </button>
                <button class="btn-logout-yes" onclick="confirmLogout()">
                    <span>‚úî</span> Ya, Logout
                </button>
            </div>
        </div>
    `;
    
    const logoutStyle = document.createElement('style');
    logoutStyle.id = 'logoutModalStyles';
    logoutStyle.textContent = `
        .logout-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:10002;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}.logout-modal.active{display:flex;opacity:1}.logout-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);animation:fadeIn .3s}.logout-content{position:relative;background:#fff;border-radius:24px;padding:40px 35px;width:90%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:slideUpModal .4s cubic-bezier(.34,1.56,.64,1);text-align:center}@keyframes slideUpModal{from{opacity:0;transform:translateY(40px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}.logout-icon{margin-bottom:25px}.icon-circle{width:90px;height:90px;margin:0 auto;background:linear-gradient(135deg,#ff6b6b,#ff5252);border-radius:50%;display:flex;align-items:center;justify-content:center;animation:bounceIn .6s cubic-bezier(.34,1.56,.64,1);box-shadow:0 8px 24px rgba(255,107,107,.3)}.icon-circle span{font-size:45px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}@keyframes bounceIn{0%{transform:scale(0);opacity:0}50%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}.logout-title{font-size:26px;font-weight:700;color:#2c3e50;margin-bottom:12px;animation:fadeInDown .5s ease .2s both}.logout-message{font-size:16px;color:#7f8c8d;margin-bottom:30px;line-height:1.6;animation:fadeInDown .5s ease .3s both}.logout-actions{display:flex;gap:12px;animation:fadeInUp .5s ease .4s both}.btn-logout-no,.btn-logout-yes{flex:1;padding:14px 24px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px}.btn-logout-no{background:#ecf0f1;color:#2c3e50}.btn-logout-no:hover{background:#d5dbdc;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}.btn-logout-yes{background:linear-gradient(135deg,#ff6b6b,#ff5252);color:#fff;box-shadow:0 4px 15px rgba(255,107,107,.3)}.btn-logout-yes:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,107,107,.4)}.btn-logout-no:active,.btn-logout-yes:active{transform:translateY(0)}@media (max-width:480px){.logout-content{padding:35px 25px}.icon-circle{width:75px;height:75px}.icon-circle span{font-size:38px}.logout-title{font-size:22px}.logout-message{font-size:14px}.logout-actions{flex-direction:column}.btn-logout-no,.btn-logout-yes{width:100%}}
    `;
    
    if (!document.getElementById('logoutModalStyles')) {
        document.head.appendChild(logoutStyle);
    }
    return modal;
}

// Close Logout Modal
function closeLogoutModal() {
    const modal = document.getElementById('logoutModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// Confirm Logout
function confirmLogout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('username');
    showNotification('Logout berhasil! Mengalihkan ke halaman login...', 'success');
    closeLogoutModal();
    setTimeout(() => {
        window.location.href = 'login.html';
    }, 1000);
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLogoutModal();
    }
});